<% products = Oroshi::Product.all %>
<% supply_types = Oroshi::SupplyType.all %>

<h2 class="mb-4">商品 <small class="text-muted">Product</small></h2>

<p class="text-muted mb-4">
  販売する商品を登録してください。商品は材料タイプに紐づきます。
</p>

<% if products.any? %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">登録済みの商品</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th>名前</th>
              <th>単位</th>
              <th>材料タイプ</th>
              <th>寸法</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% products.each do |product| %>
              <tr>
                <td><%= product.name %></td>
                <td><%= product.units %></td>
                <td><%= product.supply_type&.name %></td>
                <td>
                  <% if product.exterior_height.positive? || product.exterior_width.positive? || product.exterior_depth.positive? %>
                    <%= product.exterior_height %>×<%= product.exterior_width %>×<%= product.exterior_depth %> mm
                  <% else %>
                    —
                  <% end %>
                </td>
                <td class="text-end">
                  <%= button_to "削除",
                                oroshi_onboarding_path(@step, delete_product_id: product.id),
                                method: :patch,
                                class: "btn btn-sm btn-outline-danger",
                                data: { turbo_confirm: "この商品を削除しますか？" } %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<% else %>
  <div class="alert alert-info mb-4">
    <i class="bi bi-info-circle me-2"></i>
    商品がまだ登録されていません。少なくとも1つ追加してください。
  </div>
<% end %>

<div class="card">
  <div class="card-header">
    <h5 class="mb-0">新しい商品を追加</h5>
  </div>
  <div class="card-body">
    <%= f.fields_for :product do |p| %>
      <div class="row">
        <div class="col-md-4 mb-3">
          <%= p.label :name, '名前 *', class: 'form-label' %>
          <%= p.text_field :name,
                          placeholder: '例: みかんM（5kg）',
                          required: products.empty?,
                          class: 'form-control' %>
        </div>

        <div class="col-md-4 mb-3">
          <%= p.label :units, '単位 *', class: 'form-label' %>
          <%= p.text_field :units,
                          placeholder: '例: 箱、袋、パック',
                          required: products.empty?,
                          class: 'form-control' %>
          <div class="form-text">販売時の単位（箱、袋など）</div>
        </div>

        <div class="col-md-4 mb-3">
          <%= p.label :supply_type_id, '材料タイプ *', class: 'form-label' %>
          <% if supply_types.any? %>
            <%= p.select :supply_type_id,
                         supply_types.map { |st| ["#{st.name} (#{st.units})", st.id] },
                         { prompt: '選択してください' },
                         { class: 'form-select', required: products.empty? } %>
          <% else %>
            <div class="form-text text-danger">材料タイプが登録されていません</div>
          <% end %>
        </div>
      </div>

      <div class="row">
        <div class="col-md-12 mb-2">
          <label class="form-label">外寸（オプション）</label>
        </div>
        <div class="col-md-4 mb-3">
          <%= p.label :exterior_height, '高さ (mm)', class: 'form-label visually-hidden' %>
          <div class="input-group">
            <%= p.number_field :exterior_height,
                              min: 0,
                              placeholder: '高さ',
                              value: 0,
                              class: 'form-control' %>
            <span class="input-group-text">mm</span>
          </div>
        </div>

        <div class="col-md-4 mb-3">
          <%= p.label :exterior_width, '幅 (mm)', class: 'form-label visually-hidden' %>
          <div class="input-group">
            <%= p.number_field :exterior_width,
                              min: 0,
                              placeholder: '幅',
                              value: 0,
                              class: 'form-control' %>
            <span class="input-group-text">mm</span>
          </div>
        </div>

        <div class="col-md-4 mb-3">
          <%= p.label :exterior_depth, '奥行 (mm)', class: 'form-label visually-hidden' %>
          <div class="input-group">
            <%= p.number_field :exterior_depth,
                              min: 0,
                              placeholder: '奥行',
                              value: 0,
                              class: 'form-control' %>
            <span class="input-group-text">mm</span>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<% if products.empty? %>
  <div class="alert alert-warning mt-3">
    <i class="bi bi-exclamation-triangle me-2"></i>
    続行するには少なくとも1つの商品が必要です。
  </div>
<% end %>
