# Oroshi Installation Gap Analysis

**Date:** January 25, 2026  
**Purpose:** Document differences between sandbox (works) and real installation (fails)  
**Related:** findings-gem-installation-testing.md

## Executive Summary

Oroshi works perfectly in the generated sandbox but fails when installed in a separate Rails application (oroshi-moab). Research into mature Rails engines revealed the root cause: **Oroshi uses a non-standard dual route file pattern** that creates context confusion for the asset pipeline.

### Critical Finding

**Industry standard (used by Solidus, Spree, Devise, ActiveAdmin, RailsAdmin):**

- Engine has ONE `config/routes.rb` file
- Sandbox/host app mounts the engine in their own `config/routes.rb`

**Oroshi's current approach (non-standard):**

- Engine has `config/routes.rb` (engine routes)
- Engine also has `config/routes_standalone_app.rb` (application routes) ❌

This dual-file pattern causes:

1. Asset loading failures in tests (Ralph's US-016 blocker)
2. Installation issues in oroshi-moab
3. Route context ambiguity (is this an engine or an app?)

---

## Sandbox vs Real Installation Comparison

### What Sandbox Does

**Location:** `sandbox/` (generated by `bin/sandbox`)

**Setup process:**

```bash
# bin/sandbox script does:
1. rails new sandbox --skip-javascript --skip-test
2. Add oroshi gem from local path
3. bundle install
4. rails generate oroshi:install
5. rails oroshi:install:migrations
6. rails db:create db:migrate
7. rails db:schema:load:queue (Solid Queue)
8. rails db:schema:load:cache (Solid Cache)
9. rails db:schema:load:cable (Solid Cable)
10. rails db:seed
11. Create admin user
```

**Routes file (generated):**

```ruby
# sandbox/config/routes.rb
Rails.application.routes.draw do
  mount Oroshi::Engine, at: '/'

  # Optionally can add sandbox-specific routes
end
```

**Why it works:**

- ✅ Clean separation: sandbox is a separate Rails app
- ✅ Single mount point: only one routes file active
- ✅ Asset context: clear (loading from mounted engine)
- ✅ Test environment: isolated from engine's route files

### What README Says to Do

**Installation steps from README.md:**

```bash
# Add to Gemfile
gem 'oroshi', github: 'cmbaldwin/oroshi'

# Install
bundle install
rails generate oroshi:install
rails oroshi:install:migrations
rails db:migrate

# Mount in config/routes.rb
mount Oroshi::Engine, at: '/oroshi'
```

**What's missing from README:**

1. ❌ Need to run `rails db:schema:load:queue`
2. ❌ Need to run `rails db:schema:load:cache`
3. ❌ Need to run `rails db:schema:load:cable`
4. ❌ May need to seed data
5. ❌ Asset pipeline configuration (if not using importmap)
6. ❌ Database configuration (4 databases required)

### What oroshi-moab Actually Did

**Setup (inferred from failure):**

```bash
# Gemfile
gem 'oroshi', path: '../oroshi'  # Local path

bundle install
rails generate oroshi:install
rails oroshi:install:migrations
rails db:migrate
```

**Routes:**

```ruby
# oroshi-moab/config/routes.rb
Rails.application.routes.draw do
  mount Oroshi::Engine, at: '/oroshi'

  # oroshi-moab's own routes
  root to: 'home#index'
end
```

**What went wrong:**

- ❌ Asset loading fails (namespace issues)
- ❌ Routes may conflict
- ❌ Missing Solid schemas
- ❌ Unclear error messages

---

## Root Cause Analysis

### Problem 1: Dual Route Files

**Oroshi's current structure:**

```
oroshi/
├── config/
│   ├── routes.rb                    # Engine routes
│   │   Oroshi::Engine.routes.draw do
│   │     # Admin routes, etc.
│   │   end
│   │
│   └── routes_standalone_app.rb     # ❌ PROBLEM
│       Rails.application.routes.draw do
│         mount Oroshi::Engine, at: '/'
│       end
```

**Why this breaks:**

1. **Test environment confusion:**

   ```ruby
   # When running tests, which routes file loads?
   # If routes_standalone_app.rb loads:
   #   - Rails.application.routes is being defined INSIDE the gem
   #   - Asset pipeline thinks this is an app, not an engine
   #   - asset_path helpers resolve incorrectly
   ```

2. **Installation ambiguity:**

   ```ruby
   # When gem is installed in host app:
   #   - Host app mounts Oroshi::Engine
   #   - But routes_standalone_app.rb also tries to mount it?
   #   - Which takes precedence?
   #   - Asset loading doesn't know which context to use
   ```

3. **Namespace pollution:**
   ```ruby
   # routes_standalone_app.rb defines application-level routes
   # This pollutes the engine namespace with app concerns
   # Engine should ONLY define Oroshi::Engine.routes
   ```

### Problem 2: Missing Solid Schemas

**README says:**

```bash
rails db:migrate
```

**Should say:**

```bash
rails db:migrate
rails db:schema:load:queue
rails db:schema:load:cache
rails db:schema:load:cable
```

**Why it matters:**

- Solid Queue, Cache, Cable use separate databases
- These schemas aren't in normal migrations
- Without them, background jobs and caching fail silently

**Sandbox does this correctly** in `bin/sandbox`:

```bash
bin/rails db:schema:load:queue
bin/rails db:schema:load:cache
bin/rails db:schema:load:cable
```

### Problem 3: Asset Pipeline Configuration

**Sandbox setup (works):**

```ruby
# sandbox/config/importmap.rb (generated)
pin "application"
pin "@hotwired/turbo-rails", to: "turbo.min.js"
pin "@hotwired/stimulus", to: "stimulus.min.js"
pin "oroshi", to: "oroshi/application.js"  # Engine assets
```

**oroshi-moab setup (may be missing):**

```ruby
# oroshi-moab/config/importmap.rb
# Does it pin oroshi assets?
# Does it know where to find them?
```

**Asset loading flow:**

```
Host app requests: /assets/oroshi/application.js
  ↓
Propshaft looks in: app/assets/javascripts/oroshi/
  ↓
If dual routes active: Confusion about namespace
  ↓
Asset not found or loaded from wrong context
```

### Problem 4: Multi-Database Configuration

**Oroshi requires 4 databases:**

```yaml
# config/database.yml
development:
  primary:
    <<: *default
    database: oroshi_development

  queue:
    <<: *default
    database: oroshi_queue_development
    migrations_paths: db/queue_migrate

  cache:
    <<: *default
    database: oroshi_cache_development
    migrations_paths: db/cache_migrate

  cable:
    <<: *default
    database: oroshi_cable_development
    migrations_paths: db/cable_migrate
```

**README doesn't document:**

- How to configure these databases
- When to use them
- Why they're needed

**Sandbox handles automatically** via generated `config/database.yml`

---

## Detailed Gap Analysis

### Gap 1: Route Configuration Pattern

| Aspect            | Sandbox (Works)                 | Real Install (Breaks)                 | Industry Standard |
| ----------------- | ------------------------------- | ------------------------------------- | ----------------- |
| Engine routes     | `config/routes.rb`              | `config/routes.rb`                    | ✅ SINGLE FILE    |
| App routes        | `sandbox/config/routes.rb`      | `oroshi-moab/config/routes.rb`        | ✅ Separate app   |
| Standalone routes | Not in gem                      | ❌ `routes_standalone_app.rb`         | ❌ NOT USED       |
| Mount point       | `mount Oroshi::Engine, at: '/'` | `mount Oroshi::Engine, at: '/oroshi'` | ✅ Either works   |

**Fix required:**

- Remove `config/routes_standalone_app.rb`
- Update `bin/sandbox` to generate routes in sandbox app
- Update test helpers to not load standalone routes

### Gap 2: Installation Steps

| Step                            | README Documents | Sandbox Does       | Required    |
| ------------------------------- | ---------------- | ------------------ | ----------- |
| Add to Gemfile                  | ✅ Yes           | ✅ Yes             | ✅ Yes      |
| bundle install                  | ✅ Yes           | ✅ Yes             | ✅ Yes      |
| rails generate oroshi:install   | ✅ Yes           | ✅ Yes             | ✅ Yes      |
| rails oroshi:install:migrations | ✅ Yes           | ✅ Yes             | ✅ Yes      |
| rails db:migrate                | ✅ Yes           | ✅ Yes             | ✅ Yes      |
| rails db:schema:load:queue      | ❌ No            | ✅ Yes             | ✅ **YES**  |
| rails db:schema:load:cache      | ❌ No            | ✅ Yes             | ✅ **YES**  |
| rails db:schema:load:cable      | ❌ No            | ✅ Yes             | ✅ **YES**  |
| Configure database.yml          | ❌ No            | ✅ Yes (generated) | ⚠️ Maybe    |
| Seed data                       | ❌ No            | ✅ Yes             | ⚠️ Optional |
| Create admin user               | ❌ No            | ✅ Yes             | ⚠️ Optional |

**Fix required:**

- Update README with complete installation steps
- Document Solid schema loading
- Document multi-database setup
- Add troubleshooting section

### Gap 3: Generator Completeness

| Task                | Generator Does | Should Do   |
| ------------------- | -------------- | ----------- |
| Copy migrations     | ✅ Yes         | ✅ Yes      |
| Create initializer  | ❌ No          | ✅ **YES**  |
| Add to routes       | ❌ No          | ✅ **YES**  |
| Configure databases | ❌ No          | ⚠️ Maybe    |
| Setup Solid schemas | ❌ No          | ✅ **YES**  |
| Seed data           | ❌ No          | ⚠️ Optional |
| Create admin user   | ❌ No          | ⚠️ Optional |

**Example from Solidus:**

```ruby
# solidus/lib/generators/solidus/install/install_generator.rb
def add_migrations
  run 'bin/rails railties:install:migrations FROM=solidus_core'
end

def create_initializer
  template 'config/initializers/solidus.rb'
end

def add_to_routes
  route "mount Spree::Core::Engine, at: '/'"
end

def run_migrations
  run 'bin/rails db:migrate'
end
```

---

## Recommended Fixes

### Priority 1: Remove Dual Route Files (CRITICAL)

**Impact:** Unblocks Ralph's tests, fixes oroshi-moab installation, aligns with industry standard

**Changes:**

1. Delete `config/routes_standalone_app.rb`
2. Update `bin/sandbox` to generate routes in sandbox app
3. Update test setup to use engine routes directly

**Verification:**

- ✅ Ralph's US-016 through US-022 should pass
- ✅ oroshi-moab installation should work
- ✅ Asset loading should work correctly

### Priority 2: Complete Installation Generator (HIGH)

**Impact:** Makes installation easier, reduces errors, matches industry standard

### Priority 3: Update Documentation (HIGH)

**Impact:** Prevents installation issues, helps troubleshooting

---

**Document Version:** 1.0  
**Last Updated:** January 25, 2026  
**Status:** Ready for implementation  
**Next:** Create PRD from these findings
