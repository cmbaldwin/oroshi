#!/bin/bash
set -e

echo "ðŸ§ª Running pre-deploy checks..."
echo "==============================="

# Run RuboCop
echo "ðŸ” Running RuboCop linter..."
if ! bundle exec rubocop --fail-level error; then
  echo "âŒ RuboCop found errors that must be fixed before deployment" >&2
  exit 1
fi
echo "âœ… RuboCop passed"

# Run Brakeman security scanner (if available)
echo "ðŸ”’ Running Brakeman security scan..."
if command -v brakeman &> /dev/null || bundle show brakeman &> /dev/null; then
  if ! bundle exec brakeman --quiet --no-pager --exit-on-warn; then
    echo "âŒ Brakeman found security issues that must be fixed before deployment" >&2
    exit 1
  fi
  echo "âœ… Brakeman passed"
else
  echo "âš ï¸  Brakeman not installed - skipping security scan" >&2
  echo "â„¹ï¸  Add 'gem \"brakeman\"' to Gemfile to enable" >&2
fi

# Run tests
echo "ðŸ§ª Running test suite..."
if [ "${SKIP_TESTS:-false}" = "false" ]; then
  # Run tests excluding system tests (too slow for pre-deployment)
  if ! bin/rails test; then
    echo "âŒ Tests failed - fix failing tests before deployment" >&2
    exit 1
  fi
  echo "âœ… Tests passed"
else
  echo "â­ï¸  Skipping tests (SKIP_TESTS=true)"
fi

# Standard Kamal pre-build checks
echo "ðŸ” Running Kamal pre-build checks..."

# Check git remote
remote_name="origin"
if ! git remote | grep -q "^${remote_name}$"; then
  echo "âŒ No ${remote_name} remote set, aborting..." >&2
  exit 1
fi

# Check current branch
current_branch=$(git branch --show-current)
if [ -z "$current_branch" ]; then
  echo "âŒ Not on a git branch, aborting..." >&2
  exit 1
fi

# Verify local and remote are in sync
git fetch $remote_name $current_branch
remote_head=$(git rev-parse $remote_name/$current_branch)
local_head=$(git rev-parse HEAD)

if [ "$local_head" != "$remote_head" ]; then
  echo "âŒ Local and remote are out of sync" >&2
  echo "   Local:  $local_head" >&2
  echo "   Remote: $remote_head" >&2
  echo "   Push your changes first: git push $remote_name $current_branch" >&2
  exit 1
fi

echo "âœ… All pre-deploy checks passed! Deployment can proceed."
echo "=================================================="
