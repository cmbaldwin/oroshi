#!/bin/bash
set -e

echo "üß™ Running pre-deploy checks..."
echo "==============================="

# Run locale sync (optional, requires LOCALE_SYNC_ENABLED=true)
if [ "${LOCALE_SYNC_ENABLED:-false}" = "true" ]; then
  echo "üåê Running locale sync..."

  # Detect missing translations
  echo "üîç Detecting missing translations..."
  if ! OUTPUT=/tmp/locale_report.txt bin/rails locale:detect; then
    echo "‚ö†Ô∏è  Warning: locale:detect failed, continuing anyway..." >&2
  fi

  # Generate missing translations if OpenRouter credentials available
  if [ -n "${OPENROUTER_API_KEY:-}" ] || [ -n "$(bundle exec rails runner "puts CredentialProvider.get('openrouter', 'api_key') rescue ''" 2>/dev/null)" ]; then
    echo "ü§ñ Generating missing translations with OpenRouter..."

    # Generate translations for all configured locales
    for locale in en; do
      echo "  üìù Generating $locale translations..."
      if ! bin/rails locale:generate LOCALE=$locale; then
        echo "‚ö†Ô∏è  Warning: Failed to generate $locale translations, continuing..." >&2
      fi
    done

    echo "‚úÖ Locale sync completed"
  else
    echo "‚ö†Ô∏è  OpenRouter API key not found - skipping translation generation" >&2
    echo "‚ÑπÔ∏è  Set OPENROUTER_API_KEY or configure in Rails credentials" >&2
  fi
else
  echo "‚è≠Ô∏è  Skipping locale sync (LOCALE_SYNC_ENABLED not set to true)"
fi

# Run Gitleaks secret scanner
echo "üîê Running Gitleaks secret scanner..."
if ! command -v gitleaks &> /dev/null; then
  echo "‚ö†Ô∏è  Gitleaks not installed - skipping secret scan" >&2
  echo "‚ÑπÔ∏è  Install with: brew install gitleaks" >&2
else
  if ! gitleaks detect --source . --log-level error --redact; then
    echo "‚ùå Gitleaks found exposed secrets that must be removed before deployment" >&2
    echo "‚ÑπÔ∏è  Review findings above and remove any credentials from git history" >&2
    exit 1
  fi
  echo "‚úÖ Gitleaks passed - no secrets detected"
fi

# Run GitGuardian ggshield scanner
echo "üõ°Ô∏è  Running GitGuardian ggshield scanner..."
if ! command -v ggshield &> /dev/null; then
  echo "‚ö†Ô∏è  ggshield not installed - skipping GitGuardian scan" >&2
  echo "‚ÑπÔ∏è  Install with: brew install gitguardian/tap/ggshield" >&2
else
  if ! ggshield secret scan repo . --exit-zero --show-secrets > /dev/null 2>&1; then
    echo "‚ùå GitGuardian found exposed secrets that must be removed before deployment" >&2
    echo "‚ÑπÔ∏è  Run 'ggshield secret scan repo .' for detailed findings" >&2
    exit 1
  fi
  echo "‚úÖ GitGuardian passed - no secrets detected"
fi

# Run RuboCop
echo "üîç Running RuboCop linter..."
if ! bundle exec rubocop --fail-level error; then
  echo "‚ùå RuboCop found errors that must be fixed before deployment" >&2
  exit 1
fi
echo "‚úÖ RuboCop passed"

# Run Brakeman security scanner (uses config/brakeman.ignore for documented warnings)
echo "üîí Running Brakeman security scan..."
if ! bundle exec brakeman --quiet --no-pager --exit-on-warn; then
  echo "‚ùå Brakeman found security issues that must be fixed before deployment" >&2
  echo "‚ÑπÔ∏è  Note: Mass Assignment warnings are documented in config/brakeman.ignore" >&2
  exit 1
fi
echo "‚úÖ Brakeman passed"

# Run tests
echo "üß™ Running Test::Unit test suite..."
if [ "${SKIP_TESTS:-false}" = "false" ]; then
  # Run tests excluding system tests (too slow for pre-deployment)
  # System tests should be run manually or in CI
  if ! bin/rails test; then
    echo "‚ùå Tests failed - fix failing tests before deployment" >&2
    exit 1
  fi
  echo "‚úÖ Tests passed"
else
  echo "‚è≠Ô∏è  Skipping tests (SKIP_TESTS=true, set to false to enable)"
fi

# Check if there are any changes to commit
echo "üìù Checking for uncommitted changes..."
if [[ -n $(git status --porcelain) ]]; then
  echo "üìö Found uncommitted changes, generating commit message..."

  # Stage all changes
  git add .

  # Generate commit message using Claude if available
  if command -v claude &> /dev/null; then
    echo "ü§ñ Generating commit message with Claude..."
    CLAUDE_MSG=$(echo "Generate a concise commit message for these staged changes. Focus on the main improvements and fixes." | claude --quiet 2>/dev/null || echo "")
  fi

  # Fallback message if Claude generation fails
  if [[ -z "$CLAUDE_MSG" ]]; then
    CLAUDE_MSG="chore: pre-deploy updates and improvements"
    echo "‚ö†Ô∏è  Using fallback commit message"
  else
    echo "‚ú® Generated commit message: $CLAUDE_MSG"
  fi

  # Create commit with Claude-generated message and attribution
  FULL_COMMIT_MSG="$CLAUDE_MSG

ü§ñ Generated with Claude Code assistance

Co-Authored-By: Claude <noreply@anthropic.com>"

  echo "üíæ Committing changes..."
  git commit -m "$FULL_COMMIT_MSG"

  # Push to remote
  echo "üöÄ Pushing to remote repository..."
  git push

  echo "‚úÖ Changes committed and pushed successfully!"
else
  echo "üìã No uncommitted changes found."
fi

# Standard Kamal pre-build checks
echo "üîç Running standard Kamal pre-build checks..."

# Use origin remote specifically for GitHub
remote_name="origin"
if ! git remote | grep -q "^${remote_name}$"; then
  echo "‚ùå No ${remote_name} remote set, aborting..." >&2
  exit 1
fi

current_branch=$(git branch --show-current)
if [ -z "$current_branch" ]; then
  echo "‚ùå Not on a git branch, aborting..." >&2
  exit 1
fi

# Get remote head after any pushes we may have made
git fetch $remote_name $current_branch
remote_head=$(git rev-parse $remote_name/$current_branch)
local_head=$(git rev-parse HEAD)

# If we just pushed changes, use the current local head as the deployment version
if [ "$local_head" = "$remote_head" ]; then
  echo "‚úÖ Local and remote are in sync (version: $local_head)"
elif [ "$KAMAL_VERSION" = "$remote_head" ]; then
  echo "‚úÖ Kamal version matches remote HEAD (version: $KAMAL_VERSION)"
else
  echo "‚ùå Version mismatch - Kamal: $KAMAL_VERSION, Local: $local_head, Remote: $remote_head" >&2
  exit 1
fi

echo "‚úÖ All pre-deploy checks passed! Deployment can proceed."
echo "=================================================="