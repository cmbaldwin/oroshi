# Ralph Progress Log
Started: Sun Jan 25 11:58:32 JST 2026
---

=== CODEBASE PATTERNS ===
- Use Solid Queue for background jobs (not Sidekiq)
- Turbo Streams for real-time updates
- Database: 4 separate databases (main, queue, cache, cable)
- Testing: Test::Unit (NOT RSpec), use bin/rails test
- i18n: Japanese-first, all UI text uses t() helpers
- Assets: Propshaft + importmap (NOT Webpack/Sprockets)
===

[2026-01-25 12:15:00] Story: US-001 - Create REALIZATIONS.md structure with table of contents
Implemented: Created .ralph/REALIZATIONS.md with markdown structure, table of contents with 8 category anchors, header explaining purpose, and entry format template in HTML comment.
Files: .ralph/REALIZATIONS.md
Tests: PASSING
Learnings for future iterations:
- REALIZATIONS.md serves as a quick reference for project-specific patterns
- Each entry should follow the Problem/Solution/Code/Gotcha/Related format
- Categories: Rails & ActiveRecord, Turbo & Stimulus, Testing, Database & Migrations, Asset Pipeline, Internationalization, Authentication & Authorization, Background Jobs

[2026-01-25 12:20:00] Story: US-002 - Extract User.insert vs User.create! realization
Implemented: Added realization entry documenting how to create Devise users without triggering email callbacks by using User.insert instead of User.create!.
Files: .ralph/REALIZATIONS.md
Tests: PASSING
Learnings for future iterations:
- User.insert skips all ActiveRecord callbacks, including Devise's confirmation email
- Must use enum integer values like User.roles[:admin] with insert
- User.insert returns row count, not the created object

[2026-01-25 12:25:00] Story: US-003 - Extract Test::Unit not RSpec realization
Implemented: Added realization entry documenting Test::Unit vs RSpec, with correct commands and syntax comparison.
Files: .ralph/REALIZATIONS.md
Tests: PASSING
Learnings for future iterations:
- Use bin/rails test (not bundle exec rspec)
- Test::Unit uses assert_* methods, not expect().to
- Factory Bot is still used for factories

[2026-01-25 12:30:00] Story: US-004 - Extract Turbo Frame lazy loading realization
Implemented: Added realization entry with lazy loading pattern documentation, common patterns, and debugging tips for "Content missing" errors.
Files: .ralph/REALIZATIONS.md
Tests: PASSING
Learnings for future iterations:
- turbo_frame_tag with src: + loading: 'lazy' defers content loading
- Frame IDs must match exactly (case-sensitive) between request and response
- "Content missing" error = ID mismatch or missing frame in response

[2026-01-25 12:35:00] Story: US-005 - Extract Japanese-first i18n realization
Implemented: Added i18n realization documenting the Japanese-first approach, lazy lookup patterns, and namespace conventions.
Files: .ralph/REALIZATIONS.md
Tests: PASSING
Learnings for future iterations:
- All UI text must use t() helper, never hardcoded strings
- Lazy lookup: t('.key') in views translates based on view path
- Add Japanese translation first before using the i18n key

[2026-01-25 03:27:00] Story: US-006 - Extract schema loading vs migration realization
Implemented: Verified comprehensive realization entry already exists in REALIZATIONS.md documenting db:schema:load vs db:migrate patterns for fresh database setups.
Files: .ralph/REALIZATIONS.md (lines 159-197)
Tests: PASSING (rubocop clean)
Learnings for future iterations:
- db:schema:load creates tables from schema.rb without executing migration code
- Use for sandbox creation, CI/CD, demo apps - any fresh database
- db:migrate for production deployments with existing data
- Gotcha: schema:load destroys existing data - only for fresh DBs

[2026-01-25 03:28:00] Story: US-007 - Extract conditional gem initializers realization
Implemented: Added comprehensive realization entry documenting the if defined?(GemName) pattern for gem initializers to prevent errors during db:create and db:migrate.
Files: .ralph/REALIZATIONS.md (Database & Migrations section)
Tests: PASSING (rubocop clean)
Learnings for future iterations:
- All gem initializers must be wrapped in if defined?(GemName) checks
- Gems not fully loaded during db:create, db:migrate, db:schema:load
- Applies to Carmen, Devise, SimpleForm, Resend, Bullet, any gem
- Example: if defined?(Carmen) { Carmen.i18n_backend.locale = :ja }
- Reference: bin/sandbox lines 280-350 for all wrapped initializers

[2026-01-25 03:29:00] Story: US-008 - Extract modal + turbo frame integration realization
Implemented: Added comprehensive Bootstrap modal + Turbo Frame integration pattern with 3-step workflow (modal container, link with data-turbo-frame, controller response), Stimulus controller pattern, and form handling options.
Files: .ralph/REALIZATIONS.md (Turbo & Stimulus section)
Tests: PASSING (rubocop clean)
Learnings for future iterations:
- Three pieces required: modal with turbo_frame_tag, link with data-turbo-frame, response with matching frame
- Use Stimulus action to trigger Bootstrap modal.show() (content loads but modal won't open without it)
- Form handling: data: { turbo: false } for standard submission, or turbo_stream for dynamic updates
- Frame IDs must match exactly between link target and response
- Reference: app/views/oroshi/buyers/index.html.erb lines 47-53

[2026-01-25 03:30:00] Story: US-009 - Extract HABTM params permit realization
Implemented: Added HABTM strong params array syntax realization documenting the association_ids: [] pattern for has_and_belongs_to_many and has_many associations.
Files: .ralph/REALIZATIONS.md (Rails & ActiveRecord section)
Tests: PASSING (rubocop clean)
Learnings for future iterations:
- HABTM associations require array syntax: association_ids: []
- Without brackets, Rails silently accepts only last value from array
- Common in Oroshi: material_ids, supply_type_variation_ids, production_zone_ids, etc.
- Debug by checking params in console: [1,2,3] becomes "3" string if brackets missing
- Reference: app/controllers/oroshi/products_controller.rb line 103

[2026-01-25 03:31:00] Story: US-010 - Extract system test setup realization
Implemented: Added system test setup realization documenting JavaScriptTest module for Selenium/headless Chrome support, authentication with Devise sign_in helper, and when to use JS vs rack_test.
Files: .ralph/REALIZATIONS.md (Testing section)
Tests: PASSING (rubocop clean)
Learnings for future iterations:
- Include JavaScriptTest module only for Turbo/Stimulus/modal tests
- JavaScriptTest makes tests ~10x slower (Selenium starts real browser)
- Use rack_test (default) for simple page visits and static content
- sign_in helper from Devise::Test::IntegrationHelpers
- Default locale I18n.locale = :ja for Japanese-first testing
- Reference: test/application_system_test_case.rb, test/system/oroshi/dashboard_test.rb
