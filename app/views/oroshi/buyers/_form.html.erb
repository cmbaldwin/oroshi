<% @buyer ||= form.object %>
<% if @buyer.errors.any? %>
<% required_fields = Oroshi::Buyer.required_fields %>

<div id="error_explanation" class="m-auto mb-2">
    <h2>
        <%= t('oroshi.dashboard.form_error_header', 
        error_count: @buyer.errors.count, 
        model_name: Oroshi::Buyer.model_name.human) %>
    </h2>

    <ul>
        <% @buyer.errors.full_messages.each do |message| %>
        <li><%= message %></li>
        <% end %>
    </ul>
</div>
<% end %>

<div class="d-flex flex-wrap place-items-center justify-content-around align-middle gap-2">

    <div class="d-flex flex-fill flex-column place-items-center justify-content-around align-middle">
        <%= label_with_validation_warning(form, :name, @buyer) %>
        <%= form.text_field :name, class: 'form-control form-control-sm' %>
    </div>

    <div class="d-flex flex-fill flex-column place-items-center justify-content-around align-middle">
        <%= label_with_validation_warning(form, :handle, @buyer) %>
        <%= form.text_field :handle, class: 'form-control form-control-sm' %>
    </div>

    <div class="d-flex flex-fill flex-column place-items-center justify-content-around align-middle">
        <%= label_with_validation_warning(form, :entity_type, @buyer) %>
        <%= form.select :entity_type,
                  Oroshi::Buyer.entity_types
                    .keys.map { |type| [I18n.t("enums.oroshi_buyer.entity_type.#{type}"), type] }, 
                  { } ,
                  { class: 'form-select form-select-sm' } %>
    </div>

    <div class="d-flex flex-fill flex-column place-items-center justify-content-around align-middle">
        <%= label_with_validation_warning(form, :representative_phone, @buyer) %>
        <%= form.text_field :representative_phone, class: 'form-control form-control-sm' %>
    </div>

    <div class="d-flex flex-fill flex-column place-items-center justify-content-around align-middle">
        <%= label_with_validation_warning(form, :fax, @buyer) %>
        <%= form.text_field :fax, class: 'form-control form-control-sm' %>
    </div>

    <div class="d-flex flex-fill flex-column place-items-center justify-content-around align-middle">
        <%= label_with_validation_warning(form, :associated_system_id, @buyer) %>
        <%= form.text_field :associated_system_id, class: 'form-control form-control-sm' %>
    </div>

    <div class="d-flex flex-fill flex-column place-items-center justify-content-around align-middle min-w-3">
        <%= label_with_validation_warning(form, :color, @buyer) %>
        <%= form.color_field :color, class: 'form-control form-control-sm' %>
    </div>

    <div class="d-flex flex-column">
        <div class="d-flex flex-column justify-content-center place-items-center align-middle">
            <%= label_with_validation_warning(form, :shipping_method_ids, @buyer) %>
            <div class="input-group-text rounded mb-1 flex-grow-1 flex-wrap justify-content-center place-items-center align-middle">
                <%= form.collection_check_boxes :shipping_method_ids, @shipping_methods, :id, :name do |shipping_method| %>
                <% object = shipping_method.object %>
                <div class="form-check form-check-inline mb-0" data-controller="tippy" data-tippy-content="<center>
                  <%= object.shipping_organization.name %> - <%= object.name %>:<br>
                  <%= t('oroshi.product_variations.cost.per_box', count: object.daily_cost) %> + <%= object.per_shipping_receptacle_cost %> + <%= object.per_freight_unit_cost %>
                </center>
                ">
                    <%= shipping_method.check_box class: "form-check-input" %>
                    <%= shipping_method.label class: "form-check-label" %>
                </div>
                <% end %>
            </div>
        </div>
    </div>

    <div class="d-flex flex-fill flex-column place-items-center justify-content-start align-middle">
        <div class="d-flex gap-1 justify-content-start place-items-start align-middle" data-controller="tippy" data-tippy-content="<%= t('oroshi.buyer.commission_percentage_explanation') %>">
            <%= label_with_validation_warning(form, :commission_percentage, @buyer) %>
        </div>
        <%= form.number_field :commission_percentage, class: 'form-control form-control-sm' %>
    </div>

    <%= render partial: 'oroshi/addresses/edit', 
            locals: { form: form, addresses: @buyer.addresses } %>
</div>

<% if @buyer_categories.any? %>
<div class="d-flex flex-wrap place-items-center justify-content-around align-middle gap-2 border-bottom border-top p-2 my-2">
    <%= form.label :buyer_category_ids, Oroshi::BuyerCategory.model_name.human %>
    <%= form.collection_check_boxes :buyer_category_ids, @buyer_categories, :id, :name do |b| %>
    <div class="form-check form-check-inline d-flex align-items-center">
        <%= b.check_box(class: "form-check-input") %>
        <%= b.label(class: "form-check-label ms-1") %>
        <span class="order-category-color ms-1" style="background-color: <%= b.object.color %>;"></span>
    </div>
    <% end %>
</div>
<% end %>

<div class="d-flex flex-fill gap-2 place-items-center justify-content-around align-middle">
    <div class="d-flex flex-fill flex-column place-items-center justify-content-around align-middle">
        <div class="d-flex gap-1 justify-content-start place-items-start align-middle" data-controller="tippy" data-tippy-content="<%= t('oroshi.buyer.handling_cost_explanation') %>">
            <%= label_with_validation_warning(form, :handling_cost, @buyer) %><%= icon('info-circle', class: 'small') %>
        </div>
        <%= form.number_field :handling_cost, class: 'form-control form-control-sm' %>
    </div>

    <div class="d-flex flex-fill flex-column place-items-center justify-content-around align-middle">
        <%= label_with_validation_warning(form, :handling_cost_notes, @buyer) %>
        <%= form.text_field :handling_cost_notes, class: 'form-control form-control-sm' %>
    </div>
</div>

<div class="d-flex flex-fill gap-2 place-items-center justify-content-around align-middle">
    <div class="d-flex flex-fill flex-column place-items-center justify-content-around align-middle">
        <div class="d-flex gap-1 justify-content-start place-items-start align-middle" data-controller="tippy" data-tippy-content="<%= t('oroshi.buyer.daily_cost_explanation') %>">
            <%= label_with_validation_warning(form, :daily_cost, @buyer) %><%= icon('info-circle', class: 'small') %>
        </div>
        <%= form.number_field :daily_cost, class: 'form-control form-control-sm' %>
    </div>

    <div class="d-flex flex-fill flex-column place-items-center justify-content-around align-middle">
        <%= label_with_validation_warning(form, :daily_cost_notes, @buyer) %>
        <%= form.text_field :daily_cost_notes, class: 'form-control form-control-sm' %>
    </div>
</div>

<div class="d-flex flex-fill gap-2 place-items-center justify-content-around align-middle">
    <div class="d-flex flex-fill flex-column place-items-center justify-content-around align-middle">
        <div class="d-flex gap-1 justify-content-start place-items-start align-middle" data-controller="tippy" data-tippy-content="<%= t('oroshi.buyer.optional_cost_explanation') %>">
            <%= label_with_validation_warning(form, :optional_cost, @buyer) %><%= icon('info-circle', class: 'small') %>
        </div>
        <%= form.number_field :optional_cost, class: 'form-control form-control-sm' %>
    </div>

    <div class="d-flex flex-fill flex-column place-items-center justify-content-around align-middle">
        <%= label_with_validation_warning(form, :optional_cost_notes, @buyer) %>
        <%= form.text_field :optional_cost_notes, class: 'form-control form-control-sm' %>
    </div>
</div>

<div class="d-flex justify-content-end align-items-center align-middle mt-2">
    <div class="form-check form-switch">
        <%= form.check_box :brokerage, class: 'form-check-input', 
                    id: 'brokerageSwitch', checked: @buyer.brokerage? %>
        <%= form.label :active, I18n.t('oroshi.buyer.brokerage'), class: 'form-check-label', for: 'brokerageSwitch' %>
    </div>
</div>

<div class="d-flex justify-content-end align-items-center align-middle">
    <div class="form-check form-switch">
        <%= form.check_box :active, 
                  { class: 'form-check-input', 
                    checked: @buyer.active?,
                    data: {
                      action: 'click->oroshi--dashboard#toggleActive',
                      refresh_targets: 'dashboard_frame'
                    } } %>
        <%= form.label :active, I18n.t('oroshi.buyer.active'), class: 'form-check-label', for: 'activeSwitch' %>
    </div>
</div>