# Ralph Progress Log
Started: Thu Jan  8 10:54:14 JST 2026
---

[2026-01-08 12:42:00] Story: US-001 - Ensure dashboard loads without data
Implemented: Added graceful nil handling for dashboard associations
Files:
  - app/controllers/oroshi/dashboard_controller.rb
  - app/views/oroshi/dashboard/_home.html.erb
  - config/locales/oroshi.ja.yml
Tests: PASSING
Learnings:
- Dashboard controller had missing methods (set_supply_type, set_shipping_organization, set_product) that were referenced in before_action but not defined
- These methods need to safely return nil when no records exist (using .first)
- View partials already handle nil checks with conditionals like @buyer.persisted? and @supply_type.present?
- Added explicit empty state for supply_reception_times which expects supplier_organization_id parameter
- Project uses Test::Unit not RSpec - use bin/rails test instead of bundle exec rspec
- Ruby 4.0.0 is installed and ./bin/dev starts cleanly

[2026-01-08 13:15:00] Story: US-022 - Create initial dev user on first boot
Implemented: Created db/seeds.rb with dev user seeding logic, updated bin/setup to run seeds
Files: db/seeds.rb, bin/setup, scripts/ralph/prd.json
Tests: SKIPPED (test suite has unrelated errors in Admin::IchibaHolidaysControllerTest)
Learnings:
- Devise confirmable module triggers email sending even with confirmed_at set during create!
- Solution: Use User.insert instead of User.create! to skip all ActiveRecord callbacks
- User.insert requires encrypted_password, not password - use Devise::Encryptor.digest(User, "password")
- User.insert requires role as integer - use User.roles[:admin] to get enum value
- db/seeds.rb is gitignored by default - need git add -f to commit
- Rubocop: Trailing whitespace detected and fixed with --autocorrect
- Idempotency confirmed: User.count.zero? check prevents duplicates
- Password validation confirmed: User.find_by(email: 'dev@oroshi.local').valid_password?('password') returns true

[2026-01-08 13:20:00] Story: US-002 - Replace logo with OROSHI text
Implemented: Pre-existing - verified implementation
Files: app/views/layouts/shared/_navbar.html.erb, app/assets/stylesheets/controllers/application.scss, app/views/layouts/application.html.erb
Tests: N/A (visual feature)
Learnings:
- OROSHI branding already implemented in navbar
- Uses Playfair Display 900 from Google Fonts
- CSS class .oroshi-brand with letter-spacing -0.03em, line-height 1
- Responsive with @media query for mobile (1.5rem vs 1.75rem)
- Hover effect transitions color to #e67e22 (orange)
- Separate mobile (d-block d-lg-none) and desktop (d-none d-lg-block) implementations

[2026-01-08 13:50:00] Story: US-003 - Create onboarding progress tracking model
Implemented: Created Oroshi::OnboardingProgress model with associations and helper methods
Files: app/models/oroshi/onboarding_progress.rb, app/models/user.rb, db/migrate/*_create_oroshi_onboarding_progresses.rb, db/schema.rb
Tests: PASSING (tested in Rails console)
Learnings:
- Generated model with `bin/rails generate model Oroshi::OnboardingProgress user:references completed_at:datetime skipped_at:datetime current_step:string completed_steps:jsonb`
- Added `default: []` to completed_steps jsonb field in migration
- Used `attribute :completed_steps, :jsonb, default: []` in model to ensure array initialization
- Rubocop: Space inside array literals required ([ step_name.to_s ] vs [step_name.to_s])
- Helper methods use .present? for boolean checks (completed?, skipped?)
- mark_step_complete! uses idempotent check (return if already completed)
- Array concatenation: completed_steps + [ step_name ] creates new array

[2026-01-08 14:00:00] Story: US-004 - Create onboarding controller with step navigation
Implemented: Created Oroshi::OnboardingController with step management and navigation
Files: app/controllers/oroshi/onboarding_controller.rb, config/routes.rb
Tests: PASSING (rubocop clean, routes verified)
Learnings:
- Generated controller with `bin/rails generate controller Oroshi::Onboarding index show update --skip-routes`
- Defined STEPS as frozen hash with phases: foundation, setup, configuration, completion
- ALL_STEPS flattens STEPS values for easy iteration and validation
- before_action :find_or_create_progress ensures progress record exists
- index action uses redirect_to oroshi_onboarding_path(@step) - path helper takes step as param
- update action uses next_step helper to advance through ALL_STEPS array
- skip/resume actions are member routes (POST /oroshi/onboarding/:id/skip)
- Routes configured with resources :onboarding, only: [:index, :show, :update] and member block for skip/resume

[2026-01-08 14:10:00] Story: US-005 - Create fullscreen wizard layout
Implemented: Created onboarding.html.erb layout with gradient design and progress indicator
Files: app/views/layouts/onboarding.html.erb, app/views/layouts/onboarding/_progress.html.erb, app/views/oroshi/onboarding/show.html.erb, app/controllers/oroshi/onboarding_controller.rb
Tests: PASSING (Rails loads successfully)
Learnings:
- Layout uses embedded <style> tag for onboarding-specific styles
- Gradient background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)
- Progress partial calculates current phase by iterating STEPS hash
- Progress bar width calculated as: (current_index + 1).to_f / all_steps.length * 100
- Skip button uses button_to with turbo_confirm for confirmation dialog
- Back button only shows if current step index > 0 (not first step)
- Next button uses type="submit" form="onboarding-form" to submit from outside form
- Controller sets layout "onboarding" at class level
- Rubocop incorrectly parses ERB files as Ruby - expected behavior for view files

[2026-01-08 17:15:00] Infrastructure: Gitleaks Secret Scanning Integration
Implemented: Added gitleaks to CI pipeline for credential leak detection
Files: .kamal/hooks/pre-build, .github/copilot-instructions.md, AGENTS.md
Tests: N/A (infrastructure change)
Learnings:
- Gitleaks 8.30.0 installed via homebrew (brew install gitleaks)
- Scans git history only with --source . flag (ignores log files)
- Added as FIRST check in pre-build hook (before linting/testing)
- Graceful fallback if gitleaks not installed (warning, not error)
- Verified clean scan: no secrets in 16 commits (~2.12MB scanned in 561ms)
- Use --log-level error in CI to reduce noise
- Use --redact flag to hide potential matches in output
- Command: gitleaks detect --source . --log-level error --redact
- User initially requested "bitguard" but meant gitleaks (common alias)

[2026-01-09 17:30:00] Infrastructure: GitGuardian ggshield Integration
Implemented: Added ggshield secret scanning to complement gitleaks in CI pipeline
Files: .kamal/hooks/pre-build, .github/copilot-instructions.md, AGENTS.md
Tests: N/A (infrastructure change)
Learnings:
- ggshield 1.46.0 already installed via homebrew
- Added after gitleaks for dual-layer secret detection
- Uses `ggshield secret scan repo . --exit-zero --show-secrets` to scan git history
- --exit-zero flag prevents scan from failing build (uses custom exit code check instead)
- Redirects output to /dev/null to reduce noise, shows error message on failure
- Graceful fallback if not installed (warning, not error)
- Both tools provide complementary detection patterns (gitleaks + GitGuardian database)
- Pre-build hook now runs TWO secret scanners before linting/testing
- Command: ggshield secret scan repo . --exit-zero --show-secrets

[2026-01-09 18:00:00] Story: US-006 - Add before_action to redirect incomplete users to onboarding
Implemented: Added check_onboarding before_action to ApplicationController with proper skip conditions
Files: app/controllers/application_controller.rb
Tests: PASSING (controller tests pass, rubocop clean)
Learnings:
- Use controller_path == "oroshi/onboarding" to skip specific controllers
- devise_controller? helper available in ApplicationController for skipping Devise
- Auto-create onboarding_progress if missing: current_user.onboarding_progress || current_user.create_onboarding_progress!
- Return early guards for cleaner conditionals: return if progress.completed? || progress.skipped?
- Added to ApplicationController since all Oroshi controllers inherit from it directly (not Oroshi::ApplicationController)

[2026-01-09 20:15:00] Story: US-007 - Company info onboarding step
Implemented: Created company_info step partial with form saving to Setting
Files:
  - app/controllers/oroshi/onboarding_controller.rb (updated STEPS, added save_step_data)
  - app/views/oroshi/onboarding/show.html.erb (dynamic partial rendering)
  - app/views/oroshi/onboarding/steps/_company_info.html.erb (new)
  - test/controllers/oroshi/onboarding_controller_test.rb (updated for new steps)
Tests: PASSING (17 tests, 33 assertions)
Learnings:
- STEPS constant now uses: foundation, supply_chain, sales, shipping phases
- lookup_context.template_exists?(path, [], true) for checking partial existence
- save_step_data pattern: case/when to dispatch to step-specific save methods
- company_info requires company name validation before proceeding
- Setting model stores JSONB in settings column, accessed via .settings hash

[2026-01-09 21:00:00] Story: US-008 - Supply reception time onboarding step
Implemented: Created supply_reception_time step with add/delete functionality
Files:
  - app/views/oroshi/onboarding/steps/_supply_reception_time.html.erb (new)
  - app/controllers/oroshi/onboarding_controller.rb (added save_supply_reception_time)
Tests: PASSING (17 tests, 33 assertions in onboarding controller)
Learnings:
- Use :deleted symbol return value to signal deletion action; check in update action to stay on same step
- Check params[:key].present? before accessing nested params to avoid ActionController::ParameterMissing
- Required fields only when collection is empty: required: collection.empty?
- Button_to with method: :patch can include extra params in URL for deletion IDs
- Oroshi::SupplyReceptionTime requires hour (integer) and time_qualifier (string)

[2026-01-09 22:00:00] Story: US-009 - Supplier organization onboarding step
Implemented: Created supplier_organization step with form and controller logic
Files:
  - app/views/oroshi/onboarding/steps/_supplier_organization.html.erb (new)
  - app/controllers/oroshi/onboarding_controller.rb (added save_supplier_organization)
Tests: PASSING (17 tests, 33 assertions)
Learnings:
- SupplierOrganization model uses Carmen gem for country/subregion with numeric country_id and coded subregion_id
- Reuse existing oroshi--dashboard Stimulus controller for dynamic subregion updates (data-action: 'change->oroshi--dashboard#updateSubregions')
- Wrap country/subregion selects in .country-subregion-select container with .subregion-select inner div for Stimulus targeting
- HABTM association with supply_reception_times uses supply_reception_time_ids: [] in params.permit
- Check free_entry inclusion validation requires explicit true/false, not just presence
- Entity types enum: union, company, individual, other - use I18n.t("enums.oroshi_supplier_organization.entity_type.#{type}") for display

[2026-01-09 23:15:00] Story: US-010 - Supplier onboarding step
Implemented: Pre-existing - verified implementation complete
Files:
  - app/views/oroshi/onboarding/steps/_supplier.html.erb (already exists)
  - app/controllers/oroshi/onboarding_controller.rb (save_supplier already exists)
Tests: PASSING (17 tests, 33 assertions)
Learnings:
- Supplier model requires: company_name, supplier_number, representatives, invoice_number, supplier_organization_id
- supplier_number is 1-19, displayed as circled number (①-⑲) using Unicode codepoints 9312-9331
- supply_type_variation_ids HABTM shows empty message when no variations exist yet (created in later step)
- Step uses same pattern as supplier_organization: table of existing + add form card
- Partial was already implemented but prd.json wasn't updated to passes: true

[2026-01-09 23:30:00] Story: US-011 - Supply type onboarding step
Implemented: Created supply type onboarding step partial and controller method
Files:
  - app/views/oroshi/onboarding/steps/_supply_type.html.erb (new)
  - app/controllers/oroshi/onboarding_controller.rb (added save_supply_type)
Tests: PASSING (17 tests, 33 assertions)
Learnings:
- SupplyType model requires: name, units, handle, liquid (boolean with inclusion validation)
- liquid field uses inclusion: { in: [true, false] } so checkbox works correctly
- handle is system identifier for referencing supply types programmatically
- Same pattern: table + form card, delete via button_to with :deleted return

[2026-01-09 23:45:00] Story: US-012 - Supply type variation onboarding step
Implemented: Created supply type variation onboarding step with supplier association
Files:
  - app/views/oroshi/onboarding/steps/_supply_type_variation.html.erb (new)
  - app/controllers/oroshi/onboarding_controller.rb (added save_supply_type_variation)
Tests: PASSING (17 tests, 33 assertions)
Learnings:
- SupplyTypeVariation requires: supply_type_id, name, default_container_count
- HABTM with suppliers via supplier_ids: [] in params.permit
- Shows first supply_type in info alert for context
- Checkbox multi-select uses { multiple: true } option
- End of supply_chain phase - next is sales phase (buyer)

[2026-01-10 00:00:00] Story: US-013 - Buyer onboarding step
Implemented: Created buyer onboarding step with all required fields
Files:
  - app/views/oroshi/onboarding/steps/_buyer.html.erb (new)
  - app/controllers/oroshi/onboarding_controller.rb (added save_buyer)
Tests: PASSING (17 tests, 33 assertions)
Learnings:
- Buyer model requires: name, handle, handling_cost, daily_cost, entity_type, optional_cost, commission_percentage, color
- color field uses regex validation: /\A#(?:[0-9a-fA-F]{3}){1,2}\z/
- color_field helper generates HTML5 color picker input
- entity_type enum: wholesale_market, retailer, company, individual, other
- Use I18n.t with default: for graceful fallback when translation missing

[2026-01-10 00:15:00] Story: US-014 - Product onboarding step
Implemented: Created product onboarding step with supply type association
Files:
  - app/views/oroshi/onboarding/steps/_product.html.erb (new)
  - app/controllers/oroshi/onboarding_controller.rb (added save_product)
Tests: PASSING (17 tests, 33 assertions)
Learnings:
- Product requires: name, units, supply_type_id
- exterior_height/width/depth validated with greater_than_or_equal_to: 0
- Dimensions are optional, default to 0 using value: 0 in number_field
- Table displays dimensions as HxWxD mm or dash if all zero

[2026-01-10 00:30:00] Story: US-015 - Product variation onboarding step
Implemented: Created product variation onboarding step with dependency handling
Files:
  - app/views/oroshi/onboarding/steps/_product_variation.html.erb (new)
  - app/controllers/oroshi/onboarding_controller.rb (added save_product_variation)
Tests: PASSING (17 tests, 33 assertions)
Learnings:
- ProductVariation requires: name, handle, default_shipping_receptacle_id, production_zones, primary_content_volume, country_id, subregion_id
- Has complex dependencies: ShippingReceptacle and ProductionZone must exist
- Step allows skip if dependencies missing (skip_if_dependencies_missing logic)
- Uses Carmen gem for country/subregion with oroshi--dashboard Stimulus controller
- HABTM: production_zone_ids: [], supply_type_variation_ids: []
- Graceful fallback: shows info message when dependencies missing, hides form

[2026-01-10 00:45:00] Story: US-016 - Shipping organization onboarding step
Implemented: Created shipping organization onboarding step
Files:
  - app/views/oroshi/onboarding/steps/_shipping_organization.html.erb (new)
  - app/controllers/oroshi/onboarding_controller.rb (added save_shipping_organization)
Tests: PASSING (17 tests, 33 assertions)
Learnings:
- ShippingOrganization is simple: only requires name and handle
- handle has uniqueness validation
- Examples: ヤマト運輸, 佐川急便

[2026-01-10 01:00:00] Story: US-017 - Shipping method onboarding step
Implemented: Created shipping method onboarding step with buyer association
Files:
  - app/views/oroshi/onboarding/steps/_shipping_method.html.erb (new)
  - app/controllers/oroshi/onboarding_controller.rb (added save_shipping_method)
Tests: PASSING (17 tests, 33 assertions)
Learnings:
- ShippingMethod requires: name, handle, shipping_organization_id, daily_cost, per_shipping_receptacle_cost, per_freight_unit_cost
- All cost fields validate >= 0
- HABTM with buyers via buyer_ids: []
- number_to_currency helper for displaying costs in table

[2026-01-10 01:15:00] Story: US-018 - Shipping receptacle onboarding step
Implemented: Created shipping receptacle onboarding step with dimension fields
Files:
  - app/views/oroshi/onboarding/steps/_shipping_receptacle.html.erb (new)
  - app/controllers/oroshi/onboarding_controller.rb (added save_shipping_receptacle)
Tests: PASSING (17 tests, 33 assertions)
Learnings:
- ShippingReceptacle requires: name, handle, cost, default_freight_bundle_quantity
- Interior dimensions: interior_height/width/depth (for per_box_quantity calculation)
- Exterior dimensions optional: exterior_height/width/depth
- default_freight_bundle_quantity validates > 0, defaults to 10

[2026-01-10 01:30:00] Story: US-019 - Order category onboarding step
Implemented: Created order category onboarding step (final step)
Files:
  - app/views/oroshi/onboarding/steps/_order_category.html.erb (new)
  - app/controllers/oroshi/onboarding_controller.rb (added save_order_category)
  - test/controllers/oroshi/onboarding_controller_test.rb (updated to create OrderCategory)
Tests: PASSING (17 tests, 33 assertions)
Learnings:
- OrderCategory is simple: only requires name and color
- Color picker uses color_field helper like Buyer
- Final step shows success alert indicating onboarding completion
- Tests for last step need to create OrderCategory first (save_step_data returns false without any)

[2026-01-10 01:45:00] Story: US-020 - Create checklist sidebar component
Implemented: Created sidebar checklist for skipped onboarding users
Files:
  - app/views/oroshi/onboarding/_checklist_sidebar.html.erb (new)
  - app/views/layouts/application.html.erb (render sidebar)
  - app/controllers/oroshi/onboarding_controller.rb (added dismiss_checklist action)
  - config/routes.rb (added dismiss_checklist collection route)
Tests: PASSING (17 tests, 33 assertions)
Learnings:
- Sidebar only shows when progress.skipped? && !progress.completed?
- Uses STEPS constant from OnboardingController to group by phase
- step_completed? method checks if step is in completed_steps array
- Modal with Bootstrap for dismiss confirmation
- dismiss_checklist action uses respond_to? check for column (US-021 will add column)
