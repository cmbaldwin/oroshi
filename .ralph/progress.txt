# Ralph Progress Log
Started: Sun Jan 25 18:19:00 JST 2026
---

[2026-01-25 18:35:00] Story: US-001 Remove dual route files
Implemented: Removed dual route file pattern and adopted single engine route pattern
Files:
- config/routes_standalone_app.rb (deleted)
- config/routes_oroshi_engine.rb (deleted)
- config/routes.rb (updated comments)
- oroshi.gemspec (simplified, removed file exclusions)
Tests: PASSING (engine routes load correctly with 261 routes, model tests pass)
Learnings for future iterations:
- Oroshi uses single route file pattern: config/routes.rb with Oroshi::Engine.routes.draw
- Parent apps mount with: mount Oroshi::Engine, at: "/oroshi"
- sandbox script already generates its own routes.rb that mounts the engine
- gemspec no longer needs to exclude any config files
- Engine route helpers work without prefix inside engine, use oroshi.* prefix from parent

[2026-01-25 19:30:00] Story: US-002 Update sandbox generation script
Implemented: Fixed port inconsistency and verified sandbox generation works correctly
Files:
- bin/sandbox (updated port 3000 -> 3001 in 3 places)
- lib/tasks/sandbox.rake (updated port 3000 -> 3001)
Tests: PASSING (sandbox creates, routes load, model tests pass)
Learnings for future iterations:
- Sandbox runs on port 3001 to avoid conflicts with development server (port 3000)
- Routes file is GENERATED by bin/sandbox, not copied from gem
- Generated routes.rb demonstrates proper engine mounting pattern for parent apps
- Sandbox uses bin/dev which reads Procfile.dev for port configuration
- All port references must be consistent: bin/sandbox, sandbox.rake, CLAUDE.md, prompt.md

[2026-01-26 08:35:00] Story: US-003 Update test environment configuration
Implemented: Verified test environment already correctly configured for engine routes
Files:
- test/test_helper.rb (verified - uses Oroshi::Engine.routes.url_helpers)
- test/application_system_test_case.rb (verified - uses oroshi helper method)
- test/dummy/config/routes.rb (verified - properly mounts engine at /oroshi)
Tests: PASSING (controller: 26, integration: 11, system: 4 - all pass)
Learnings for future iterations:
- Test environment was already correct - previous work established the pattern
- test_helper.rb provides oroshi helper method returning Oroshi::Engine.routes.url_helpers
- Integration tests use oroshi_* helper methods (e.g., oroshi_root_path, oroshi_orders_path)
- System tests use same pattern via ApplicationSystemTestCase
- No routes_standalone_app.rb references in test directory (confirmed with grep)
- Sass deprecation warnings are from external gems (Bootstrap), not asset loading errors
- Rails deprecation warnings for resource hash arguments are cosmetic

[2026-01-26 09:45:00] Story: US-004 Verify oroshi-moab installation works
Implemented: Fixed critical engine isolation issues and verified installation works
Files Modified:
- config/routes.rb (removed Rails.application.routes.draw block - engine ONLY uses Engine.routes.draw)
- app/helpers/oroshi/application_helper.rb (NEW - moved helpers from ApplicationHelper)
- app/controllers/oroshi/application_controller.rb (added helper Oroshi::ApplicationHelper)
- test/test_helper.rb (changed to use dummy app environment)
- test/controllers/routes_test.rb (updated root route test expectation)
- test/dummy/config/cable.yml (NEW - ActionCable test config)
- test/dummy/config/storage.yml (NEW - ActiveStorage test config)
- test/dummy/db/schema.rb (copied from main app)
Parent App Changes (oroshi-moab):
- config/routes.rb (added root route for main_app.root_path to work)
Tests: PASSING (controller: 26, dashboard integration: 11 - 37 runs, 66 assertions)
Learnings for future iterations:
- Engine config/routes.rb must ONLY contain Oroshi::Engine.routes.draw - no Rails.application.routes.draw
- Non-namespaced ApplicationHelper is shadowed by parent app - use Oroshi::ApplicationHelper
- Parent apps MUST define a root route if engine views use main_app.root_path
- test_helper.rb must use test/dummy/config/environment for proper engine testing
- FactoryBot needs find_definitions called manually after changing definition_file_paths
- Engine controllers need: helper Oroshi::ApplicationHelper to access title, icon, date helpers
- Dummy app needs cable.yml with 'test: adapter: test' for ActionCable tests
- Dummy app needs storage.yml for ActiveStorage tests

[2026-01-26 10:15:00] Story: US-005 Update documentation for route pattern
Implemented: Comprehensive documentation of single route file pattern across all project docs
Files Modified:
- README.md (added Route Architecture section with examples and requirements)
- CLAUDE.md (enhanced Engine Isolation & Routing with detailed pattern documentation)
- .ralph/prompt.md (added gotchas #11 and #12 for route pattern and parent requirements)
- .ralph/REALIZATIONS.md (added Rails Engine Patterns section with Single Route File Pattern entry)
- config/routes.rb (enhanced header comment with CRITICAL warnings and references)
Tests: PASSING (controller: 26 tests, rubocop clean)
Learnings for future iterations:
- Documentation for patterns should be in MULTIPLE places: README (users), CLAUDE.md (developers), REALIZATIONS.md (future AI agents)
- config/routes.rb header comment is first place new developers look - make it comprehensive
- The single route file pattern prevents dual route file mistakes that break asset loading
- Key principle: engine uses Oroshi::Engine.routes.draw, parent uses Rails.application.routes.draw
- Route helper context table is useful: from engine vs from parent app, with/without prefix

[2026-01-26 10:30:00] Story: US-006 Create install generator
Implemented: Enhanced install generator with comprehensive documentation and new features
Files Modified:
- lib/generators/oroshi/install/install_generator.rb (comprehensive overhaul)
Features Added:
- Comprehensive header comment (60+ lines) explaining usage, prerequisites, and steps
- Method-level comments for all 11 generator steps
- --run-migrations flag to optionally run db:migrate and Solid schema loads
- add_root_route step to ensure parent app has root route for main_app.root_path
- Improved mount_engine with comment about changing mount path
- Conditional post-install instructions based on --run-migrations flag
Tests: PASSING (rubocop clean, controller tests pass)
Learnings for future iterations:
- Rails generators should have comprehensive header comments explaining all options
- Optional flags (--run-migrations) are better than forced execution for DB operations
- Generator should handle edge cases like existing files and already-mounted engines
- Step-by-step numbering in comments helps developers understand the flow
- The generator is idempotent - safe to run multiple times

[2026-01-26 09:30:00] Story: US-007 Create generator tests
Implemented: Comprehensive test suite for install generator with bug fixes
Files Modified:
- test/lib/generators/oroshi/install/install_generator_test.rb (NEW - 10 test cases)
- lib/generators/oroshi/install/install_generator.rb (fixed path resolution bugs)
Features Added:
- 10 test cases covering all generator functionality
- Tests for initializer creation, user model generation, skip options
- Tests for schema copying, database.yml creation
- Stubbed rake and route methods for test environment
Bug Fixes:
- Fixed File.exist? calls to use File.join(destination_root, path)
- Added app_name helper method for database.yml template ERB rendering
- Fixed routes path checks to use destination_root
Tests: PASSING (10 runs, 33 assertions, 0 failures, 0 errors)
Learnings for future iterations:
- Rails generator tests must use destination_root for all file paths
- File.exist?("relative/path") checks CWD, not destination - ALWAYS use File.join(destination_root, path)
- Thor/ERB templates can't access @instance_variables - use helper methods instead
- rake() and route() methods don't work in Rails::Generators::TestCase - must stub them
- Prepend modules to stub Thor methods without argument validation errors
- Generator tests verify behavior (method calls) not side effects (actual file changes)
- Test::Unit uses assert_file, assert_no_file, run_generator helpers
- SimpleCov shows 100% coverage for generator when all public methods tested

[2026-01-26 09:50:00] Story: US-008 Add README installation instructions
Implemented: Comprehensive troubleshooting section added to README
Files Modified:
- README.md (added 200+ lines of troubleshooting documentation)
Features Added:
- Troubleshooting section with 9 common installation issues
- Each issue has: problem description, solutions with commands, explanations
Issues Documented:
1. "No route matches" errors - engine mount and root route verification
2. Asset loading failures - Propshaft configuration and asset paths
3. Database connection errors - 4-database setup verification
4. "Table does not exist" for solid_* tables - schema loading commands
5. Devise errors - installation and configuration steps
6. User model conflicts - skip options and required enum/modules
7. "uninitialized constant Oroshi::" - autoload and Zeitwerk config
8. Background jobs not processing - Solid Queue worker startup
9. WebSocket/Turbo Streams not working - Action Cable and cable database
- Getting Help section with log checking and issue reporting guidelines
Tests: N/A (documentation only)
Learnings for future iterations:
- Good troubleshooting docs need: problem description, multiple solutions, why it happens
- Include exact commands users can run to diagnose and fix
- Group related errors together (all Solid gems, all Devise issues, etc.)
- Link to logs and support resources
- README already had good installation instructions - enhanced with troubleshooting

[2026-01-26 10:10:00] Story: US-009 Create CI installation test
Implemented: GitHub Actions workflow for automated installation testing
Files Created:
- .github/workflows/installation.yml (comprehensive installation test)
Features Added:
- Matrix strategy testing Ruby 3.4 and 4.0 with Rails 8.1
- Creates fresh Rails application with PostgreSQL
- Adds Oroshi gem and runs install generator
- Verifies all generated files (initializer, User model, routes, Solid schemas)
- Configures 4-database setup automatically
- Runs migrations and loads Solid schemas
- Verifies all 4 databases created (primary, queue, cache, cable)
- Tests Rails application boot
- Verifies Oroshi routes accessible
- Uploads logs on failure for debugging
- Runs on push to main/develop and on pull requests
Tests: Workflow validated (YAML syntax check passed)
Learnings for future iterations:
- CI installation tests should create completely fresh Rails app (not use engine's test env)
- Use matrix strategy for testing multiple Ruby/Rails versions efficiently
- Separate verification steps make debugging easier when one fails
- Use timeout on boot test to prevent hanging CI
- Upload artifacts (logs) on failure for post-mortem debugging
- Test both file creation AND functional verification (routes accessible, app boots)
- PostgreSQL service needs health checks to ensure it's ready before database operations
- YAML heredocs (<<EOF) work in GitHub Actions for multi-line file creation

[2026-01-26 09:40:00] Story: US-010 Create installation verification command
Implemented: Comprehensive installation verification rake task with 9 checks
Files Modified:
- lib/tasks/verify_installation.rake (NEW - 271 lines)
- test/lib/verify_installation_rake_test.rb (NEW - 185 lines, 15 tests)
- README.md (added verification section)
Features Added:
- oroshi:verify_installation rake task with 9 critical checks
- Color-coded output with ✓ (pass), ✗ (fail), ⚠ (warning) indicators
- Checks: engine mount, initializer, root route, 4 databases, migrations, Solid schemas, User model
- Actionable error messages for each failed check with specific commands to fix
- Summary report with counts of passed/failed/warnings/errors
- Exit codes: 0 on success, 1 on failure
- 15 comprehensive test cases covering all functionality
Tests: PASSING (15 runs, 34 assertions, 0 failures, 0 errors)
Learnings for future iterations:
- Rake tasks that invoke Rails application need :environment prerequisite
- Use capture_io to test rake task output in Test::Unit
- SystemExit should be caught in tests when task uses exit() calls
- Rails.application.routes.routes.any? to check if engine is mounted
- ActiveRecord::Base.connected_to(role: :writing, shard: :name) to access specific databases
- Color Unicode characters (✓ ✗ ⚠) work in terminal but complicate regex matching in tests
- Task provides user value even when checks fail - diagnostic tool is successful if it identifies problems
- Verification tasks should check configuration files exist AND runtime state is correct
- Exit codes enable CI integration - can fail build if installation incomplete

[2026-01-26 10:00:00] Story: US-011 Test oroshi-moab installation end-to-end
Implemented: Comprehensive end-to-end installation test with documentation
Files Modified:
- docs/testing/oroshi-moab-installation-test.md (NEW - 284 lines, 10-step procedure)
- lib/tasks/verify_installation.rake (FIXED - changed oroshi_users to oroshi_buyers check)
Testing Performed:
- Verified oroshi gem installation in parent app (oroshi-moab)
- Tested 4-database setup (primary, queue, cache, cable)
- Ran all migrations (69 files with .oroshi.rb extensions)
- Loaded Solid schemas for queue, cache, and cable databases
- Ran oroshi:verify_installation task (8/9 checks passed, 1 expected warning)
- Verified 270 routes loaded (261 from engine + 9 from parent)
- Tested server boot (starts without errors)
- Confirmed Solid Queue worker functionality
Test Result: PASS with HIGH confidence
Learnings for future iterations:
- Verification tasks must account for parent app differences (users vs oroshi_users table)
- establish_connection() returns ConnectionPool, call .connection to get actual connection
- Parent apps may customize User model, so warnings about associations are expected
- Document test procedures with exact commands for repeatability
- 10-step test procedure takes ~5 minutes to complete
- Test documentation should include: prerequisites, steps, results, issues, workarounds
- Verification task is invaluable for QA - instantly diagnoses installation state
- Route refactoring successfully validated: single file pattern works in parent apps
