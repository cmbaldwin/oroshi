<div id='<%= "revenue_#{product.id}" %>' class="card">
  <div class="card-header h4 text-start">
    <%= product %>
  </div>

  <div class="card-body d-flex flex-column gap-2">
    <% product_total = 0 %>
    <% product_revenue_minus_handling_total = 0 %>
    <% product_expense_total = 0 %>
    <% product_orders.group_by(&:product_variation).each do |product_variation, product_variation_orders| %>

      <% product_variation_revenue_minus_handling = product_variation_orders.map(&:revenue_minus_handling).sum %>
      <% product_revenue_minus_handling_total += product_variation_revenue_minus_handling %>

      <% product_variation_expense_total = product_variation_orders.map(&:expenses).sum %>
      <% product_expense_total += product_variation_expense_total %>

      <% product_variation_total = product_variation_orders.map(&:total).sum %>
      <% product_total += product_variation_total %>

      <div class="card flex-row">
        <div class="bg-light rounded-start vertical border-end p-3 fw-bold">
          <%= product_variation.name %>
        </div>
        <div class="card m-1 flex-fill d-flex flex-column justify-content-between">
          <ul class="list-group list-group-flush">
            <% product_variation_orders.each do |order| %>
              <%= render partial: 'oroshi/orders/dashboard/revenue/order/revenue_order',
                        locals: { order: order } %>
            <% end %>
          </ul>

          <div class="card-footer d-flex flex-column flex-md-row justify-content-end gap-1">
            <div class="d-flex flex-column flex-md-row gap-1">
              <div class="input-group input-group-sm justify-content-end align-middle place-items-end flex-nowrap">
                <span class="input-group-text px-2 py-1" alt="収入小計"
                      data-controller="tippy"
                      data-tippy-content="<%= product_variation.name %> 収入小計">
                      収入小計
                </span>
                <span class="input-group-text px-2 py-1 fw-bold fs-6" alt="経費引く前の合計"
                      data-controller="tippy"
                      data-tippy-content="注文総合計">
                      <%= yenify(product_variation_revenue_minus_handling) %> 円
                </span>
              </div>
              <div class="input-group input-group-sm justify-content-end align-middle place-items-end flex-nowrap">
                <span class="input-group-text px-2 py-1" alt="経費小計"
                      data-controller="tippy"
                      data-tippy-content="<%= product_variation.name %> 経費小計">
                      経費小計
                </span>
                <span class="input-group-text px-2 py-1 fw-bold fs-6" alt="経費引く前の合計"
                      data-controller="tippy"
                      data-tippy-content="注文総合計">
                      - <%= yenify(product_variation_expense_total) %> 円
                </span>
              </div>
              <div class="input-group input-group-sm justify-content-end align-middle place-items-end flex-nowrap">
                <span class="input-group-text px-2 py-1" alt="合計"
                      data-controller="tippy"
                      data-tippy-content="<%= product_variation.name %> 合計">
                      合計
                </span>
                <span class="input-group-text bg-light px-2 py-1 fw-bold fs-5" alt="経費引く前の合計"
                      data-controller="tippy"
                      data-tippy-content="注文総合計">
                      <%= yenify(product_variation_total) %> 円
                </span>
              </div>
            </div>
          </div>

        </div>
      </div>

    <% end %>

  </div>

  <div class="card-footer d-flex flex-column flex-md-row justify-content-end gap-1">

    <div class="input-group input-group-sm justify-content-end align-middle place-items-end flex-nowrap">
      <span class="input-group-text px-2 py-1" alt="<%= product %> 収入小計"
            data-controller="tippy"
            data-tippy-content="<%= product %> 収入小計">
            <%= product %> 収入小計
      </span>
      <span class="input-group-text px-2 py-1 fw-bold fs-6" alt="経費引く前の合計"
            data-controller="tippy"
            data-tippy-content="注文総合計">
            <%= yenify(product_revenue_minus_handling_total) %> 円
      </span>
    </div>

    <div class="input-group input-group-sm justify-content-end align-middle place-items-end flex-nowrap">
      <span class="input-group-text px-2 py-1" alt="<%= product %> 経費小計"
            data-controller="tippy"
            data-tippy-content="<%= product %> 経費小計">
            <%= product %> 経費小計
      </span>
      <span class="input-group-text px-2 py-1 fw-bold fs-6" alt="経費引く前の合計"
            data-controller="tippy"
            data-tippy-content="注文総合計">
            - <%= yenify(product_expense_total) %> 円
      </span>
    </div>

    <div class="input-group input-group-sm justify-content-end align-middle place-items-end flex-nowrap">
      <span class="input-group-text px-2 py-1" alt="<%= product %> 収入小計"
            data-controller="tippy"
            data-tippy-content="<%= product %> 収入小計">
            <%= product %> 収入小計
      </span>
      <span class="input-group-text px-2 py-1 fw-bold fs-5 bg-secondary" alt="経費引く前の合計"
            data-controller="tippy"
            data-tippy-content="注文総合計">
            <%= yenify(product_total) %> 円
      </span>
    </div>

  </div>

</div>